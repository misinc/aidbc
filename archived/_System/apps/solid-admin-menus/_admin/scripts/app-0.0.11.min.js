var _menuFile=BCAPI.Models.FileSystem.Root.file("/_System/Apps/solid-admin-menus/_config/menu.json");var _originalMenuFile=BCAPI.Models.FileSystem.Root.file("/_System/Apps/solid-admin-menus/_config/menu_orig.json");var _menuIconsFolder=new BCAPI.Models.FileSystem.Folder("/_System/Apps/solid-admin-menus/_admin/content/menu-icons");var _currentMenuItems;var _currentMenuItemsArray;var _currentNavItemImage;var _adminMenuLabelsHtmlId="menu-custom-labels";var _invisibleTitle="Hidden from users";var _visibleTitle="Visible to all users";var _graybackButtonClass="greyback";var _linksToNewWindowTitle="Link opens in a new window";var _linksToAdminAreaTitle="Links opens in admin area";var _removesNavigationItemTitle="Removes navigation item";var _visibleGlyphiconClass="glyphicon-eye-open";var _invisibleGlyphiconClass="glyphicon-eye-close";var _linksToNewWindowGlyphiconClass="glyphicon-new-window";var _linksToAdminAreaGlyphiconClass="glyphicon-unchecked";var _removesNavigationItemGlyphiconClass="glyphicon-minus-sign";var _subNavigationExpandedGlyphiconClass="glyphicon-circle-arrow-down";var _subNavigationCollapsedGlyphiconClass="glyphicon-circle-arrow-right";var _defaultIconClass="default-icon";var _userDefinedNavItemClass="user-defined";var _validFileExtensions=[".png"];var _customIconClass="custom-icon";var _newNavTypeDropdownSelector;var _httpsRecommendedForAdminWindowWarningHtml="<div class=\"nav-item-warning-message alert alert-warning\">'https' is recommended for admin links for maximum compatibility. </div>";function hasSubNavItems(a){return($(a).find(".sub-nav-items .nav-item-container").length>0)}function isAdminTarget(a){return $(a).find(".nav-item-toggle-target span."+_linksToAdminAreaGlyphiconClass).length===1}function reassignWeights(b){function a(c){$.each(c,function(d,e){$(e).find(".nav-item-weight input").first().val((d+1)*10000)})}a(b.children("li").children(".nav-item-container"))}function postLoadNavigationData(){var a=$(".nav-item-container:not(.sub-nav-items .nav-item-container)","#left-admin-menu");$(".nav-item-warning-message").remove();var b=a.filter(function(){var h=$(this).find('input[type="url"]').val();return(h===""&&hasSubNavItems(this)===false)});$('<div class="nav-item-warning-message alert alert-warning">This item will not appear in the menu until either a URL is entered or sub menu items are added</div>').insertBefore(b.find(".sub-nav-items"));var c=a.filter(function(){var h=$(this).find('input[type="url"]:not(.sub-nav-items input[type="url"])').val();return(h!==undefined&&h!==""&&hasSubNavItems(this)===true)});$('<div class="nav-item-warning-message alert alert-warning">It is not recommended to have a URL on a parent menu item when there are sub menu items</div>').insertBefore(c.find(".sub-nav-items"));var e=$(".sub-nav-items .nav-item-container","#left-admin-menu").filter(function(){var h=$(this).find('input[type="url"]').val();return(h!==undefined&&h==="")});e.append('<div class="nav-item-warning-message alert alert-warning">Sub menu items should have a URL</div>');var d=$(".nav-item-container:not(.sub-nav-items .nav-item-container)","#left-admin-menu").filter(function(){var h=$(this).find('input[type="url"]:not(.sub-nav-items input[type="url"])').val();return(isAdminTarget(this)&&h!==undefined&&h!==""&&h.indexOf("https")!==0)});$(_httpsRecommendedForAdminWindowWarningHtml).insertBefore(d.find(".sub-nav-items"));var g=$(".nav-item-container","#top-admin-menu").filter(function(){var h=$(this).find('input[type="url"]').val();return(isAdminTarget(this)&&h!==undefined&&h!==""&&h.indexOf("https")!==0)});g.append(_httpsRecommendedForAdminWindowWarningHtml);var f=$(".sub-nav-items .nav-item-container","#left-admin-menu").filter(function(){var h=$(this).find('input[type="url"]').val();return(isAdminTarget(this)&&h!==undefined&&h!==""&&h.indexOf("https")!==0)});f.append(_httpsRecommendedForAdminWindowWarningHtml);a.filter(function(){return hasSubNavItems(this)===false}).find(".nav-item-toggle-subnav").hide();a.filter(function(){return hasSubNavItems(this)===true}).find(".nav-item-toggle-subnav").show();$(".nav-item-image:not(.blank)").unbind("click").click(function(){_currentNavItemImage=this;$("#myModal").modal({keyboard:false})});$("#top-admin-menu ul, #left-admin-menu ul:not(#left-admin-menu .sub-nav-items ul), #left-admin-menu .sub-nav-items ul").sortable({update:function(h,i){reassignWeights($(i.item).parent())}})}function sortByMainNavAndWeight(d,c){if((d.menuItem.parent===undefined&&c.menuItem.parent===undefined)||(d.menuItem.parent!==undefined&&c.menuItem.parent!==undefined)){return(parseInt(d.menuItem.weight)<parseInt(c.menuItem.weight)?-1:parseInt(d.menuItem.weight)>parseInt(c.menuItem.weight)?1:0)}else{if(d.menuItem.parent===undefined){return -1}else{return 1}}}function sortByLastModified(e,d){var c=new Date(e.attributes.lastModified);var f=new Date(d.attributes.lastModified);return c<f?-1:c>f?1:0}function loadNavigationData(){_originalMenuFile.download().done(function(b){var a=$.parseJSON(b);_menuFile.download().done(function(c){_currentMenuItems=$.parseJSON(c);_currentMenuItemsArray=[];$.each(_currentMenuItems,function(d){_currentMenuItemsArray.push({menuItem:_currentMenuItems[d],key:d})});_currentMenuItemsArray.sort(sortByMainNavAndWeight);$.each(_currentMenuItemsArray,function(j,u){if(u.key.indexOf(_adminMenuLabelsHtmlId)===0){if(u.key===_adminMenuLabelsHtmlId){return}var D=u.menuItem.applyIf.userHasRoles[0];$("#access-rights-container").find('input[value="'+D+'"]').attr("checked","checked");return}var g;var d="blank";var p=false;var k=false;var C=false;var v="Menu Title";if(a[u.key]!==undefined){v=a[u.key].title}if((u.menuItem.parent===""||u.menuItem.parent===undefined)&&u.key.indexOf("ribbon")!==0){g=$("#left-admin-menu").find("ul:not(#left-admin-menu .sub-nav-items ul)");p=u.key.indexOf("menu-AdminMenuLabels-")==0;if(p==false){d=u.key.substring(5)}else{d=_userDefinedNavItemClass}var r=u.menuItem.title;if(r===""){r=v}_newNavTypeDropdownSelector.append($("<option>",{value:u.key+"-subnav"}).text("Left > "+r))}else{if(u.key.indexOf("ribbon")===0){g=$("#top-admin-menu").find("ul");p=true;C=true;$("#no-top-nav-items-label").hide()}else{p=u.key.indexOf("menu-AdminMenuLabels-")==0;g=$("#"+u.menuItem.parent+"-subnav ul");k=true}}var x;var y;var t="";var l=(u.menuItem.attr!==undefined&&u.menuItem.attr.target!==undefined&&u.menuItem.attr.target==="_blank");if(l===true){x=_linksToNewWindowTitle;y=_linksToNewWindowGlyphiconClass}else{x=_linksToAdminAreaTitle;y=_linksToAdminAreaGlyphiconClass;t=_graybackButtonClass}var m;var e;var h="";var s=(u.menuItem.visible!==false);if(s===true){m=_visibleGlyphiconClass;e=_visibleTitle}else{m=_invisibleGlyphiconClass;e=_invisibleTitle;h=_graybackButtonClass}var o="";var B="";var w="";if(u.menuItem.attr!==undefined&&u.menuItem.attr.href!==undefined){w=u.menuItem.attr.href}if(p===true){o=['<div class="nav-item-toggle-remove">','<button type="button" class="btn btn-default btn-sm" title="'+_removesNavigationItemTitle+'">','<span class="glyphicon '+_removesNavigationItemGlyphiconClass+'"></span>',"</button>","</div>"].join("\n");B=['<div class="nav-item-url">','<input type="url" value="'+w+'" placeholder="URL" />',"</div>",'<div class="nav-item-toggle-target">','<button type="button" class="btn btn-default btn-sm '+t+'" title="'+x+'">','<span class="glyphicon '+y+'"></span>',"</button>","</div>"].join("\n")}var f="";var A="";if(k===false&&C===false){f=['<div class="nav-item-toggle-subnav">','<button type="button" class="btn btn-default btn-sm '+_graybackButtonClass+'" title="Collapse sub menu items">','<span class="glyphicon '+_subNavigationCollapsedGlyphiconClass+'"></span> Sub Menu',"</button>","</div>"].join("\n");A=['<div id = "'+u.key+'-subnav" class="sub-nav-items" style="display:none;">',"<ul></ul>","</div>"].join("\n");var z="";var i="";var q="";if(u.menuItem.icon!==undefined){q='icon-url="'+u.menuItem.icon+'" ';i="background:url('"+u.menuItem.icon+"') 0 0 no-repeat;";z=_customIconClass}}var n=["<li>",'<div class="nav-item-container">','<input type="hidden" value="'+u.key+'"/>','<div class="nav-item-image '+d+" "+z+'" '+q+' style="'+i+'" title="Click to change icon">',"</div>",'<div class="nav-item-title">','<input type="text" value="'+u.menuItem.title+'" placeholder="'+v+'" />',"</div>",'<div class="nav-item-weight">','<input type="number" value="'+u.menuItem.weight+'" placeholder="Weight" />',"</div>",'<div class="nav-item-toggle-hide">','<button type="button" class="btn btn-default btn-sm '+h+'" title="'+e+'">','<span class="glyphicon '+m+'"></span>',"</button>","</div>",B,o,f,A,"</div>","</li>"].join("\n");$(g).append(n)});setNavigationItemButtons();postLoadNavigationData()})})}function isValidTitle(b){var a=b.replace(/ /g,"");if(b===""){return true}return/^[A-Za-z][-A-Za-z0-9_:.]*$/.test(a)===true}function isValidUrl(a){var b='((?:http|https)(?::\\/{2}[\\w]+)(?:[\\/|\\.]?)(?:[^\\s"]*))';var c=new RegExp(b,["i"]);return c.exec(a)!==null}function getUniqueHtmlId(b){var c=b.replace(/ /g,"");var a=c;var d;var e=1;do{d=$('.nav-item-container input[type="hidden"][value="'+a+'"]',"#editLabelForm").length===1;if(d){a=c+e}e+=1}while(d===true);return a}function addNewLabelToList(k){k.preventDefault();var n="";var m=$.trim($("#NewTitle").val());if(m===""){n+='You must enter a value for "Title"\n'}if(isValidTitle(m)===false){n+='You may only add alphanumeric characters for the "Title"\n'}var c=$.trim($("#NewUrl").val());if(c!==""&&isValidUrl(c)===false){n+='You must enter Urls starting with "http://" or "https://"'}if(n!==""){alert("Please fix the following errors: \n"+n);return}var h=_newNavTypeDropdownSelector.val();var g=$("#"+h+"> ul");var i=$("#NewOpenInNewWindow").is(":checked");var d;var a;var p="";if(i===true){d=_linksToNewWindowTitle;a=_linksToNewWindowGlyphiconClass}else{d=_linksToAdminAreaTitle;a=_linksToAdminAreaGlyphiconClass;p=_graybackButtonClass}var f;var l="blank";var o="";var b="";if(h==="top-admin-menu"){f=getUniqueHtmlId("ribbon-AdminMenuLabels-"+m);$("#no-top-nav-items-label").hide()}else{if(h==="left-admin-menu"){f=getUniqueHtmlId("menu-AdminMenuLabels-"+m);l=_userDefinedNavItemClass;o=['<div class="nav-item-toggle-subnav">','<button type="button" class="btn btn-default btn-sm '+_graybackButtonClass+'" title="Collapse sub menu items">','<span class="glyphicon '+_subNavigationCollapsedGlyphiconClass+'"></span> Sub Menu',"</button>","</div>"].join("\n");b=['<div id = "'+f+'-subnav" class="sub-nav-items">',"<ul></ul>","</div>"].join("\n");_newNavTypeDropdownSelector.append($("<option>",{value:f+"-subnav"}).text("Left > "+m))}else{f=getUniqueHtmlId("menu-AdminMenuLabels-"+m)}}var j=["<li>",'<div class="nav-item-container">','<input type="hidden" value="'+f+'"/>','<div class="nav-item-image '+l+'" title="Click to change icon">',"</div>",'<div class="nav-item-title">','<input type="text" value="'+m+'" placeholder="Menu Title" />',"</div>",'<div class="nav-item-weight">','<input type="number" value="-1" placeholder="Weight" />',"</div>",'<div class="nav-item-toggle-hide">','<button type="button" class="btn btn-default btn-sm" title="'+_visibleTitle+'">','<span class="glyphicon '+_visibleGlyphiconClass+'"></span>',"</button>","</div>",'<div class="nav-item-url">','<input type="url" value="'+c+'" placeholder="URL" />',"</div>",'<div class="nav-item-toggle-target">','<button type="button" class="btn btn-default btn-sm '+p+'" title="'+d+'">','<span class="glyphicon '+a+'"></span>',"</button>","</div>",'<div class="nav-item-toggle-remove">','<button type="button" class="btn btn-default btn-sm" title="'+_removesNavigationItemTitle+'">','<span class="glyphicon '+_removesNavigationItemGlyphiconClass+'"></span>',"</button>","</div>",o,b,"</div>","</li>"].join("\n");g.prepend($(j).hide().fadeIn(1500));reassignWeights(g);$("#"+f+"-subnav").hide();postLoadNavigationData();$("#addLabelForm").find('.form-actions button[type="reset"]').click();setNavigationItemButtons();showItemAddedAlert()}function setNavigationItemButtons(){$(".nav-item-toggle-hide button").unbind("click").click(function(){var a=$(this).find("span");if(a.hasClass(_visibleGlyphiconClass)){a.removeClass(_visibleGlyphiconClass);a.addClass(_invisibleGlyphiconClass);$(this).addClass(_graybackButtonClass);$(this).attr("title",_invisibleTitle)}else{a.removeClass(_invisibleGlyphiconClass);a.addClass(_visibleGlyphiconClass);$(this).removeClass(_graybackButtonClass);$(this).attr("title",_visibleTitle)}});$(".nav-item-toggle-target button").unbind("click").click(function(){var a=$(this).find("span");if(a.hasClass(_linksToNewWindowGlyphiconClass)){a.removeClass(_linksToNewWindowGlyphiconClass);a.addClass(_linksToAdminAreaGlyphiconClass);$(this).addClass(_graybackButtonClass);$(this).attr("title",_linksToAdminAreaTitle)}else{a.removeClass(_linksToAdminAreaGlyphiconClass);a.addClass(_linksToNewWindowGlyphiconClass);$(this).removeClass(_graybackButtonClass);$(this).attr("title",_linksToNewWindowTitle)}postLoadNavigationData()});$(".nav-item-toggle-subnav button").unbind("click").click(function(){var a=$(this).find("span");if(a.hasClass(_subNavigationExpandedGlyphiconClass)){a.removeClass(_subNavigationExpandedGlyphiconClass);a.addClass(_subNavigationCollapsedGlyphiconClass);$(this).addClass(_graybackButtonClass);$(this).attr("title","Expand sub menu items");$(this).parents(".nav-item-container").find(".sub-nav-items").slideUp()}else{a.removeClass(_subNavigationCollapsedGlyphiconClass);a.addClass(_subNavigationExpandedGlyphiconClass);$(this).removeClass(_graybackButtonClass);$(this).attr("title","Collapse sub menu items");$(this).parents(".nav-item-container").find(".sub-nav-items").slideDown()}});$(".nav-item-toggle-remove button").unbind("click").click(function(){if(window.confirm("Are you sure you want to remove this navigation item?")){var a=$(this).closest(".nav-item-container").find('input[type="hidden"]').first()[0].value;_newNavTypeDropdownSelector.find('option[value="'+a+'-subnav"]').each(function(){$(this).remove()});$(this).closest("li").fadeOut(500,function(){$(this).remove();if($("#top-admin-menu").find(".nav-item-container").length===0){$("#no-top-nav-items-label").show()}postLoadNavigationData()})}});$("#delete-icon").unbind("click").click(function(){var b=$(".library-icon.selected");if(b.hasClass(_defaultIconClass)){window.alert("You may not delete a default icon");return}if(b.length===0){window.alert("You must select an icon to delete");return}if(!window.confirm("Are you sure you want to remove this icon? Any menu items using this icon will no longer display it.")){return}var a=new BCAPI.Models.FileSystem.File("/_System/Apps/solid-admin-menus/_admin"+b.attr("icon-url").substring(1));a.destroy().done(function(){loadMenuIcons()})});$("#select-icon").unbind("click").click(function(){var b=$(".library-icon.selected");if(b.length===0){window.alert("You must select an icon");return}var a="/_System/Apps/solid-admin-menus/_admin"+b.attr("icon-url").substring(1);$(_currentNavItemImage).removeClass(_userDefinedNavItemClass);$(_currentNavItemImage).addClass(_customIconClass);$(_currentNavItemImage).attr("icon-url",a);$(_currentNavItemImage).css("background","url('"+a+"') 0 0 no-repeat");$("#myModal").modal("hide")});$("#upload-new-icon").find('input[type="file"]').unbind("change").change(function(){var b=this;var h=b.value;if(h.length>0){var g=false;var f;for(var a=0;a<_validFileExtensions.length;a++){f=_validFileExtensions[a];if(h.substr(h.length-f.length,f.length).toLowerCase()==f.toLowerCase()){g=true;break}}if(!g){alert("Sorry, "+h+" is invalid, allowed extensions are: "+_validFileExtensions.join(", "));return}$(".uploading-icon-message","#myModal").fadeIn();var e=$(b);var d=RAT.Helper.Primitives.generateGuid()+f;var c=BCAPI.Models.FileSystem.Root.file("/_System/Apps/solid-admin-menus/_admin/content/menu-icons/"+d);c.upload($(b)[0].files[0]).done(function(){e.replaceWith(e=e.clone(true));loadMenuIcons(d,function(){$(".uploading-icon-message","#myModal").fadeOut()})})}})}function showItemAddedAlert(){$(".new-item-added-message").show().delay(5000).fadeOut(1000)}function showSavedAlert(){$(".saved-message").show()}function showSaveAlert(){$(".save-actions").hide();$(".saving-message").show()}function revertSaveAlert(){$(".save-actions").show();$(".saving-message").hide()}function saveChanges(){showSaveAlert();var b=$(".nav-item-container","#editLabelForm");var d="";var a=$("#accessRightsForm").find('input[type="checkbox"]:checked');if(a.length===0){d+="You must select at least one role with access rights to this application.\n"}$.each(b,function(g,i){var j=$(i);var e=j.find('input[type="hidden"]').first().val();var k=j.find(".nav-item-title input").first().val();var f="";var l=e.indexOf("ribbon-")===0||e.indexOf("menu-AdminMenuLabels-")===0;if(isValidTitle(k)===false){d+='You may only add alphanumeric characters for the "Title"\n'}if(l===true){f=$.trim(j.find(".nav-item-url input").first().val());if(f!==""&&isValidUrl(f)===false){d+='You must enter Urls starting with "http://" or "https://"'}}if(_currentMenuItems[e]===undefined){_currentMenuItems[e]={}}_currentMenuItems[e].title=k;_currentMenuItems[e].weight=j.find(".nav-item-weight input").first().val();_currentMenuItems[e].visible=j.find(".nav-item-toggle-hide button").first().hasClass(_graybackButtonClass)===false;var h=j.find(".nav-item-image").first().hasClass(_customIconClass);if(h===true){_currentMenuItems[e].icon=j.find(".nav-item-image").first().attr("icon-url")}else{_currentMenuItems[e].icon=undefined}if(f!==""){_currentMenuItems[e].attr={};_currentMenuItems[e].attr.href=f;if(j.find(".nav-item-toggle-target button").first().hasClass(_graybackButtonClass)===false){_currentMenuItems[e].attr.target="_blank"}else{_currentMenuItems[e].attr.target=undefined}}else{_currentMenuItems[e].attr=undefined}if(j.closest(".sub-nav-items").length>0){_currentMenuItems[e].parent=j.closest(".sub-nav-items")[0].id.replace(/\-subnav/g,"")}else{_currentMenuItems[e].parent=undefined}});if(d!==""){alert("Please fix the following errors: \n"+d);revertSaveAlert();return}$.each(_currentMenuItems,function(e){if(e!==_adminMenuLabelsHtmlId&&$('.nav-item-container input[type="hidden"][value="'+e+'"]',"#editLabelForm").length===0){_currentMenuItems[e]=undefined}});$.each(_currentMenuItemsArray,function(e,f){if(f.key.indexOf(_adminMenuLabelsHtmlId)===0){_currentMenuItems[f.key]=undefined}});_currentMenuItems[_adminMenuLabelsHtmlId]={};_currentMenuItems[_adminMenuLabelsHtmlId].title="Admin Menu Labels";_currentMenuItems[_adminMenuLabelsHtmlId].parent="menu-site-settings";_currentMenuItems[_adminMenuLabelsHtmlId].visible=false;if(a.length>0){$.each(a,function(f,g){var e=_adminMenuLabelsHtmlId+f;_currentMenuItems[e]={};_currentMenuItems[e].title="Admin Menu Labels";_currentMenuItems[e].parent="menu-site-settings";_currentMenuItems[e].attr={};_currentMenuItems[e].attr.href="/Admin/AppLoader.aspx?client_id=solid-admin-menus";_currentMenuItems[e].weight=200000;_currentMenuItems[e].visible=false;_currentMenuItems[e].applyIf={};_currentMenuItems[e].applyIf.userHasRoles=[];_currentMenuItems[e].applyIf.userHasRoles.push($(g).attr("value"));_currentMenuItems[e+"copy"]=$.extend(true,{},_currentMenuItems[e]);_currentMenuItems[e+"copy"].visible=true})}var c=JSON.stringify(_currentMenuItems);$.each(a,function(e){c=c.replace("menu-custom-labels"+e+"copy","menu-custom-labels")});_menuFile.upload(c).done(function(){try{window.parent.location.reload()}catch(f){revertSaveAlert();showSavedAlert()}})}function loadMenuIcons(a,b){_menuIconsFolder.fetch().done(function(){var e=_menuIconsFolder.get("contents");e.sort(sortByLastModified);var h=$("#myModal").find(".library-rows");h.empty();var k;for(var j=0;j<e.length;j++){if(j%15===0){h.append('<div class = "library-row"></div>');k=$(".library-row","#myModal").last()}var g=e[j];var l=g instanceof BCAPI.Models.FileSystem.File;if(l){var d="";if(a!==undefined&&g.get("name")===a){d="selected"}var f=g.get("name").indexOf("menu_")===0?_defaultIconClass+" ":"";var c="./content/menu-icons/"+g.get("name");k.append('<div class = "library-icon '+f+d+'" icon-url="'+c+'" style="background-image:url(\''+c+"'); background-position: center; background-repeat: no-repeat;\"></div>")}}$(".library-row .library-icon").unbind("click").click(function(i){i.preventDefault();$(".library-row .library-icon").removeClass("selected");$(this).addClass("selected")});if(b!==undefined){b()}})}function restoreDefaultSettings(){if(!window.confirm("This action will restore menu items to their initial view. Are you sure you wish to proceed?")){return}showSaveAlert();_originalMenuFile.download().done(function(a){_menuFile.upload(a).done(function(){try{window.parent.location.reload()}catch(b){revertSaveAlert();showSavedAlert()}})})}$(function(){RAT.Helper.BC.appendAccessTokenToAnchors($("#tab-labels, #tab-instructions"));_newNavTypeDropdownSelector=$("#NewNavType");loadNavigationData();$("#addLabelForm").submit(function(a){addNewLabelToList(a)});$("button.save").click(function(){saveChanges()});$("button.restore-default").click(function(){restoreDefaultSettings()});$.ajax({dataType:"json",url:"/api/v2/admin/sites/"+BCAPI.Helper.Site.getSiteId()+"/roles",beforeSend:function(a){a.setRequestHeader("Authorization",BCAPI.Helper.Site.getAccessToken())},success:function(a){$.each(a.items,function(b,c){$("#access-rights-container").find(".controls").append('<label><input type = "checkbox" value="'+c.name+'">'+c.name+"</input></label>")})}});loadMenuIcons()});